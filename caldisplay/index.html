<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מלאכת מחשבת</title>
    <style>
        /* Fullscreen CSS for kiosk display */
        html, body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            direction: rtl;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .title-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px;
            margin: 0;
            width: 100%;
        }

        .logo-compartment {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-compartment .logo {
            height: 10vh;
            width: auto;
            object-fit: contain;
            border-radius: 8px;
        }

        .title-text {
            color: #4a5568;
            font-size: 3.5rem;
            margin: 0;
            font-weight: 300;
            line-height: 1.2;
        }

        .date-display {
            color: #718096;
            font-size: 1.8rem;
            margin-top: 15px;
        }

        .events-container {
            margin-top: 30px;
        }

        .event-item {
            background: #f8fafc;
            border-right: 4px solid #667eea;
            padding: 25px 30px;
            margin-bottom: 20px;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 25px;
            flex-wrap: nowrap;
        }

        .event-item:hover {
            transform: translateX(-8px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .event-time {
            font-weight: 700;
            color: #667eea;
            font-size: 2.2rem;
            margin: 0;
            min-width: 140px;
            max-width: 140px;
            text-align: center;
            background: rgba(102, 126, 234, 0.1);
            padding: 10px;
            border-radius: 8px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .event-title {
            color: #2d3748;
            font-size: 2.2rem;
            line-height: 1.3;
            margin: 0;
            flex: 1;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .no-events {
            text-align: center;
            color: #a0aec0;
            font-style: italic;
            padding: 60px 40px;
            background: #f8fafc;
            border-radius: 12px;
            font-size: 1.5rem;
        }

        .loading {
            text-align: center;
            color: #667eea;
            padding: 60px 40px;
            font-size: 1.5rem;
            font-weight: 500;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 30px;
            border-radius: 12px;
            margin-top: 30px;
            font-size: 1.2rem;
            line-height: 1.5;
        }

        .cors-info {
            background: #bee3f8;
            color: #2b6cb0;
            padding: 25px;
            border-radius: 12px;
            margin-top: 25px;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .cors-info ul {
            margin: 15px 0;
            padding-right: 20px;
        }

        .cors-info li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title-section">
                <div class="logo-compartment">
                    <img src="logo.jpg" alt="לוגו" class="logo">
                </div>
                <span class="title-text" id="dynamicTitle">מלאכת מחשבת</span>
            </div>
            <div class="date-display" id="currentDate"></div>
        </div>
        
        <div class="events-container" id="eventsContainer">
            <div class="loading">טוען אירועים...</div>
        </div>
    </div>

    <script>
        const CALENDAR_URL = 'https://calendar.google.com/calendar/ical/900a9baf687afa2100a64eecd9659483bee1f1f8e632ca79ed99347e10e82352%40group.calendar.google.com/public/basic.ics';
        
        // Proxy services to bypass CORS
        const CORS_PROXIES = [
            'https://corsproxy.io/?',
            'https://cors-anywhere.herokuapp.com/',
            'https://api.allorigins.win/raw?url='
        ];

        function displayCurrentDate() {
            const today = new Date();
            const hebrewDays = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
            const hebrewMonths = [
                'ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
                'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'
            ];
            
            const dayName = hebrewDays[today.getDay()];
            const monthName = hebrewMonths[today.getMonth()];
            
            // Update title with "מלאכת מחשבת" + day and date
            const titleElement = document.getElementById('dynamicTitle');
            titleElement.textContent = `מלאכת מחשבת - יום ${dayName}, ${today.getDate()} ב${monthName}`;
            
            // Remove the year display
            document.getElementById('currentDate').textContent = '';
        }

        function parseICS(icsData) {
            const events = [];
            const lines = icsData.split('\n');
            let currentEvent = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line === 'BEGIN:VEVENT') {
                    currentEvent = {};
                } else if (line === 'END:VEVENT' && currentEvent) {
                    events.push(currentEvent);
                    currentEvent = null;
                } else if (currentEvent) {
                    if (line.startsWith('SUMMARY:')) {
                        currentEvent.summary = line.substring(8).trim();
                    } else if (line.startsWith('DTSTART')) {
                        const dateStr = line.split(':')[1];
                        currentEvent.start = parseICSDate(dateStr);
                    } else if (line.startsWith('DTEND')) {
                        const dateStr = line.split(':')[1];
                        currentEvent.end = parseICSDate(dateStr);
                    }
                }
            }
            
            return events;
        }

        function parseICSDate(dateStr) {
            // Handle both date and datetime formats
            if (dateStr.length === 8) {
                // All-day event (YYYYMMDD)
                return new Date(
                    parseInt(dateStr.substr(0, 4)),
                    parseInt(dateStr.substr(4, 2)) - 1,
                    parseInt(dateStr.substr(6, 2))
                );
            } else if (dateStr.includes('T')) {
                // DateTime format (YYYYMMDDTHHMMSS or with Z)
                const cleanDate = dateStr.replace(/[TZ]/g, '');
                return new Date(
                    parseInt(cleanDate.substr(0, 4)),
                    parseInt(cleanDate.substr(4, 2)) - 1,
                    parseInt(cleanDate.substr(6, 2)),
                    parseInt(cleanDate.substr(8, 2)) || 0,
                    parseInt(cleanDate.substr(10, 2)) || 0,
                    parseInt(cleanDate.substr(12, 2)) || 0
                );
            }
            return new Date(dateStr);
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function formatTime(date) {
            return date.toLocaleTimeString('he-IL', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        function displayEvents(events) {
            const container = document.getElementById('eventsContainer');
            const todaysEvents = events.filter(event => 
                event.start && isToday(event.start)
            ).sort((a, b) => a.start - b.start);

            if (todaysEvents.length === 0) {
                container.innerHTML = '<div class="no-events">אין אירועים מתוכננים להיום</div>';
                return;
            }

            const eventsHTML = todaysEvents.map(event => {
                const time = event.start.getHours() === 0 && event.start.getMinutes() === 0 
                    ? 'כל היום' 
                    : formatTime(event.start);
                
                return `
                    <div class="event-item">
                        <div class="event-time">${time}</div>
                        <div class="event-title">${event.summary || 'אירוע ללא כותרת'}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = eventsHTML;
        }

        async function tryFetchWithProxy(proxyIndex = 0) {
            if (proxyIndex >= CORS_PROXIES.length) {
                throw new Error('כל שרתי הפרוקסי נכשלו');
            }

            const proxyUrl = CORS_PROXIES[proxyIndex] + encodeURIComponent(CALENDAR_URL);
            
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return await response.text();
            } catch (error) {
                console.log(`פרוקסי ${proxyIndex + 1} נכשל:`, error.message);
                return await tryFetchWithProxy(proxyIndex + 1);
            }
        }

        async function loadEvents() {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = '<div class="loading">טוען אירועים...</div>';

            try {
                const icsData = await tryFetchWithProxy();
                const events = parseICS(icsData);
                displayEvents(events);
            } catch (error) {
                console.error('Error loading calendar:', error);
                container.innerHTML = `
                    <div class="error">
                        <strong>לא ניתן לטעון את אירועי היומן</strong><br>
                        שגיאה: ${error.message}
                    </div>
                    <div class="cors-info">
                        <strong>הערה:</strong> יישומון היומן הזה צריך לעקוף את אבטחת הדפדפן (CORS) כדי לטעון את נתוני היומן שלך.
                        אם השרתי הפרוקסי לא עובדים, ייתכן שתצטרך:
                        <ul>
                            <li>להריץ את Chrome עם --disable-web-security flag, או</li>
                            <li>להקים שרת מקומי, או</li>
                            <li>להשתמש בתוסף דפדפן שמשבית CORS</li>
                        </ul>
                    </div>
                `;
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            displayCurrentDate();
            loadEvents();
        });

        // Auto-refresh every hour (60 minutes)
        setInterval(loadEvents, 60 * 60 * 1000);
    </script>
</body>
</html>
